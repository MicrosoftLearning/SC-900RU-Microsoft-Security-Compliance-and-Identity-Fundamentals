---
Demo:
    title: 'Группы безопасности сетей Azure (NSGs)'
    module: 'Модуль 3. Урок 1. Описание возможностей решений безопасности Майкрософт. Описание основных возможностей обеспечения безопасности в Azure.'
---

# Демонстрация. Группы безопасности сетей Azure (NSGs)

### Сценарий демонстрации
В рамках этой демонстрации вы покажете функциональность группы безопасности сети (NSG) в Azure.  Для этого перед проведением демонстрации необходимо сначала создать виртуальную машину (ВМ) без какой-либо группы безопасности сети. Кроме того, вам также необходимо будет создать NSG без какого-либо связанного интерфейса или подсети.  В рамках этой демонстрации вы продемонстрируете правила для входящего и исходящего трафика по умолчанию, применимые к NSG. После этого вы рассмотрите процедуру назначения интерфейса ВМ в эту группу NSG.  После настройки вы проверите подключение к ВМ с помощью правил NSG по умолчанию, а также правил, которые вы создадите самостоятельно.
  

#### Настройка перед демонстрацией, часть 1
 Инструкторам рекомендуется выполнить эти действия **ДО** начала занятия, так как создания ВМ занимает несколько минут. В рамках этой настройки вы создадите виртуальную машину Windows 10.

1. Откройте вкладку **Главная страница – Microsoft Azure** в вашем браузере.  Если ранее вы закрыли эту вкладку, откройте страницу браузера и в адресной строке введите portal.azure.com, затем выполните вход.

1. В поле поиска, которое расположено на синей верхней панели рядом с надписью Microsoft Azure, введите **Виртуальные машины**, затем выберите **Виртуальные машины** в результатах поиска.  

1. В левой верхней части страницы выберите **+Добавить**, затем выберите **+Виртуальная машина**.

1. На вкладке «Основные» заполните приведенные ниже сведения (если что-то не указано, оставьте настройки по умолчанию):
    1. **Подписка**: проверьте, что по умолчанию указано «Azure Pass – Спонсорские отношения».
    1. **Группа ресурсов**: выберите **Создать**, затем в поле «Имя» ведите **LabsSC900-RG** и нажмите кнопку **OK**.
    1. **Имя виртуальной машины**:  введите **SC900-WinVM**.
    1. **Регион**:  оставьте значение по умолчанию.
    1. **Параметры доступности**: обязательно выберите **Избыточность инфраструктуры не требуется**.  ПРИМЕЧАНИЕ. Очень важно, чтобы для параметров доступности было указано «Избыточность инфраструктуры не требуется», иначе демонстрация не будет работать.  Наличие параметра доступности означает необходимость использования NSG, а мы намеренно создали ВМ без NSG.
    1. **Образ**:  в раскрывающемся списке выберите **Windows 10 Pro, версия 20H2 — пок. 1**.
    1. **Размер**:  выберите в раскрывающемся списке **видеть все размеры**, затем выберите **B2s** и нажмите **Выбрать** в нижней части страницы.
    1. **Имя пользователя**:  введите **AzureUser**.
    1. **Пароль**:  введите **SC900AzureLabs**.
    1. **Общедоступные входящие порты**:  можно оставить настройки по умолчанию (неважно, что здесь будет выбрано, так как сетевые настройки переопределят эти значения).
    1. **Лицензирование**:  установите флажок **Подтверждаю, что имею действующую лицензию Windows 10 c правами размещения на нескольких клиентах**.
    1. Выберите **Далее: Диски**.

1. Откроется вкладка «Диски» конфигурации ВМ.  Оставьте значение по умолчанию для всех настроек и выберите **Далее: Сеть >.**

1. Откроется вкладка «Сеть» конфигурации ВМ.  Заполните приведенные ниже сведения (если что-то не указано, оставьте настройки по умолчанию):
    1. Группа безопасности сети сетевого адаптера:  выберите **Нет**.  Примечание. Выбор «Нет» гарантирует, что у сетевого адаптера не будет NSG.  На следующем шаге демонстрации вы создадите NSG и назначите сетевой адаптер ВМ созданной NSG.
    1. Поскольку остальные настройки ВМ будут иметь значения по умолчанию, можно просто нажать «Далее: **Просмотр и создание >**».

1. Обзор конфигурации для вашей ВМ.  Следует обратить внимание на несколько аспектов. Эта ВМ имеет общедоступный IP-адрес и не имеет группы безопасности сети, назначенной для сетевого адаптера.  С точки зрения безопасности эта ВМ подвержена угрозам.  Мы рассмотрим этот аспект в последующей задаче. Нажмите кнопку **Создать**.  На развертывание ВМ может уйти несколько минут.

1. Обратите внимание на имя сетевого интерфейса **sc900-winvmXXX** (XXX относится непосредственно к сетевому интерфейсу вашей ВМ).

1. По завершении развертывания ВМ выберите **Перейти к ресурсу**.  Вы попадете на страницу SC900-WinVM.  Обратите внимание на общедоступный IP-адрес.

1. На панели навигации слева выберите **Сеть** и обратите внимание на сетевой интерфейс **sc900-winvmXXX** (XXX относится непосредственно к сетевому интерфейсу вашей ВМ).  С этим интерфейсом не должно быть связано каких-либо правил входящего и исходящего трафика.  

1. В верхней части страницы выберите **Подключить**, так как важно проверить, что вы можете подключаться к этой ВМ.
    1. Убедитесь, что в верхней части страницы выбрано **RDP** (подчеркнуто).
    1. Убедитесь, что задан общедоступный IP-адрес, оставьте номер порта по умолчанию и выберите **Загрузить DRP-файл**.
    1. **Откройте** загруженный файл в появившемся окне, выберите **Подключить**.
    1. Открывается окно, в котором появится запрос на ввод учетных данных. Если в окне по умолчанию запрашивается PIN-код, выберите **Дополнительные варианты**, затем выберите **Использовать другую учетную запись**.   Вам будет предложено ввести учетные данные.  В качестве имени пользователя введите **AzureUser**.  В качестве пароля введите **SC900AzureLabs**.
    1. Открывается окно подключения к удаленному рабочему столу с сообщением, что идентификация удаленного компьютера не может быть проверена.  Продолжить в любом случае?  Выберите **Да**.
    1. Теперь вы подключены к только что созданной ВМ Windows. Завершите настройку Windows. Несмотря на то, что вы подключены к ВМ через часто используемый порт RDP, на этой ВМ открыты все порты и трафик никак не фильтруется.  Закройте подключение к удаленному рабочему столу, выбрав **X** в центре верхней части страницы, где отображается IP-адрес.  Появляется всплывающее окно с сообщением об отключении удаленного сеанса. Нажмите кнопку **ОК**.

1. Теперь вы можете вернуться на страницу SC900-WinVM портала Azure.  Оставьте эту вкладку браузера открытой для следующей задачи.

#### Настройка перед демонстрацией, часть 2
Создайте группу безопасности сети, но НЕ назначайте в эту группу сетевой интерфейс ВМ.  

1. Откройте вкладку «SC900-WinVM – Microsoft Azure» в вашем браузере.

1. В поле поиска, которое расположено на синей верхней панели рядом с надписью Microsoft Azure, введите **группа безопасности сети**, затем выберите **Группы безопасности сети** в результатах поиска.  Не выбирайте классические группы безопасности сети.

1. В верхней части страницы групп безопасности сети выберите **+ Создать**.

1. На вкладке «Основные» в странице «Создание группы безопасности сети» укажите следующие параметры.
    1. Подписка:  Azure Pass – Спонсорское предложение.
    1. Группа ресурсов:  **LabsSC900-RG**
    1. Имя:  **NSG-SC900**
    1. Регион:  оставьте значение по умолчанию **(США) Восток США**
    1. Выберите **Проверить и создать**, затем выберите **Создать**.

1. По завершении развертывания выберите **Перейти к ресурсу** и убедитесь, что все было сделано правильно.  По умолчанию должно быть 3 правила входящего трафика, 3 правила исходящего трафика без подсетей и интерфейсов, связанных с NSG.  Вернитесь на **главную** страницу портала Azure.  

#### Демонстрация
Просмотрите параметры NSG.  В этом случае нужно рассмотреть существующую NSG (созданную в рамках приведенной выше настройки), которая не была назначена интерфейсу ВМ. После этого следует продемонстрировать процессы связи интерфейса с NSG и создания правил входящего и исходящего трафика.

1. Откройте вкладку браузера **Главная — Microsoft Azure**.  Если ранее вы закрыли эту вкладку, откройте страницу браузера и в адресной строке введите portal.azure.com, затем выполните вход.

1. В поле поиска, которое расположено на синей верхней панели рядом с надписью Microsoft Azure, введите **группа безопасности сети**, затем выберите **Группы безопасности сети** в результатах поиска.  Не выбирайте классические группы безопасности сети.

1. На странице NSG выберите NSG, созданную при настройке **NSG-SC900**.

1. Выделяется вкладка **Обзор** на панели навигации слева.  Обратите внимание на правила входящего и исходящего трафика по умолчанию в NSG. Несмотря на то, что NSG уже создана и имеются правила по умолчанию для фильтрации трафика, с этой NSG нет связанных интерфейсов. Это показано в правой верней части страницы, где написано «Сопоставлено с: 0 подсетей, 0 сетевых интерфейсов».  Чтобы NSG работала, необходимо ей что-то назначить.  В нашем случае мы назначим сетевой интерфейс для ранее созданной ВМ.

1. В разделе «Параметры» на панели навигации в левой части страницы NSG-SC900 выберите **Сетевые интерфейсы**.

1. Выберите **+ Сопоставить** над полем поиска, затем в раскрывающемся списке выберите **sc900-winvmXXX** (XXX относится к конкретному сетевому интерфейсу вашей ВМ), затем **ОК**. При сопоставлении интерфейса вы увидите уведомление в правом верхнем углу экрана. После сопоставления интерфейса с NSG этот интерфейс появится в списке.

1. Вернитесь на вкладку **Обзор**.  Обратите внимание, что в верхней части страницы отображается сообщение «Сопоставлено с: 0 подсетей, 1 сетевой интерфейс» — интерфейс теперь сопоставлен с NSG. Кроме того, расскажите учащимся о правилах по умолчанию. Будет разрешен только входящий трафик из других виртуальных сетей Azure и с Azure Load Balancer. Весь прочий входящий трафик на эту ВМ будет запрещен. Также расскажите о правилах исходящего трафика по умолчанию.  Разрешен только исходящий трафик в другие виртуальные сети и в Интернет.  В рамках этой демонстрации рекомендуется показать, что входящий трафик действительно запрещен.
    1. В поле поиска в верхней части страницы введите и выберите **Виртуальные машины**.
    1. На странице «Виртуальные машины» выберите **SC900-WinVM**.
    1. В верхней части страницы SC900-WinVM выберите **Подключить**, затем выберите **RDP**.
    1. Убедитесь, что задан общедоступный IP-адрес, оставьте номер порта по умолчанию и выберите **Загрузить DRP-файл**.
    1. **Откройте** загруженный файл и выберите **Подключить**.
    1. Через несколько секунд попытки подключения появится сообщение об ошибке, указывающее, что служба удаленных рабочих столов не может подключиться к удаленному компьютеру. Нажмите кнопку **ОК**.

1. После того, как вы продемонстрировали правила входящего трафика по умолчанию для NSG, необходимо создать новое правило, которое разрешит входящий трафик RDP.  Подчеркните, что вы не можете удалить существующие правила по умолчанию, можете только создать новые с более высоким приоритетом.
    1. В разделе «Параметры» на панели навигации слева выберите **Сеть**.  Откроется страница сети ВМ. Несмотря на то, что здесь вы сможете создать правило входящего и исходящего трафика, вернитесь на страницу NSG, ведь именно группе безопасности сети посвящена наша демонстрация.  **Выберите NSG-SC900**, это ссылка в центре окна.

1. Откроется страница обзора NSG.  Обратите внимание на сведения об NSG. В разделе «Параметры» на панели навигации в левой части страницы NSG выберите **Правила входящего трафика**, затем выберите **+ Добавить** в верхней части страницы. На странице «Добавить правило безопасности входящего трафика» обсудите различные параметры. Рекомендуется создать правило, чтобы разрешить входящий трафик RDP, используя следующие параметры.
    1. Источник: **Любой**
    1. Диапазоны исходных портов: **\***
    1. Место назначения: **Любой**
    1. Служба: **RDP**
    1. Действие: **Разрешить**
    1. Приоритет: **300**; примечание: правила с меньшими значениями имеют более высокий приоритет и обрабатываются первыми. Поэтому приоритет этого нового правила должен быть выше приоритета существующего правила, которое запрещает весь входящий трафик.
    1. Имя: **AllowRDP**
    1. Нажмите **Добавить**
    1. После подготовки правило появится в списке правил входящего трафика.

1. Проверьте **Правила безопасности исходящего трафика**.  Выберите **+ Добавить** в верхней части страницы и расскажите про различные параметры.  Рекомендуется создать правило; приведенные ниже параметры создают правило для запрета исходящего интернет-трафика.
    1. Источник: **Любой**
    1. Диапазоны исходных портов: **\***
    1. Место назначения: **Тег службы**
    1. Тег службы назначения: **Интернет**
    1. Служба: **Пользовательская** (оставьте значение по умолчанию)
    1. Диапазоны портов назначения: **\*** (обязательно поставьте звездочку в поле диапазонов портов назначения).
    1. Протокол: **Любой**
    1. Действие: **Запретить**
    1. Приоритет: **4000** (здесь следует подчеркнуть, что данный приоритет должен быть выше приоритета существующего правила, которое разрешает исходящий интернет-трафик)
    1. Имя: **DenyInternet**
    1. Нажмите **Добавить**
    1. После подготовки правило появится в списке правил исходящего трафика.

1. Вернитесь к ВМ и протестируйте правила.  В верхней части страницы выберите **SC900-VM** над правилами безопасности исходящего трафика.

1. Проверьте правило входящего трафика, убедившись, что вы можете подключиться к ВМ с помощью RDP.
    1. Выберите **Подключить** на панели навигации слева.
    1. Убедитесь, что задан общедоступный IP-адрес, оставьте номер порта по умолчанию и выберите **Загрузить DRP-файл**.
    1. **Откройте** загруженный файл и выберите **Подключить**.
    1. Вам будет предложено ввести учетные данные. В качестве имени пользователя введите **AzureUser**. В качестве пароля введите **SC900AzureLabs**.  Если в окне с запросом ваших учетных данных требуется ввести PIN-код, выберите **Дополнительные варианты**, затем выберите **Использовать другую учетную запись**.
    1. Открывается окно подключения к удаленному рабочему столу с сообщением, что идентификация удаленного компьютера не может быть проверена. Продолжить в любом случае? Выберите **Да**.
    1. Вы подключены к ВМ. Расскажите участникам, что в этом случае вы сможете подключиться к ВМ, потому что созданное вами правило входящего трафика пропускает входящий трафик RDP до ВМ.

1. Теперь протестируйте правило исходящего трафика NSG
    1. Откройте браузер Edge на ВМ.
    1. Введите **https://www.bing.com**. Страница не должна отображаться. Примечание. Если вы не можете подключиться к Интернету, убедитесь, что все параметры для правил исходящего трафика правильно настроено, скорее всего, необходимо подождать несколько минут, чтобы правило вступило в силу. Подождите несколько минут и повторите попытку.

1. Закройте подключение к удаленному рабочему столу, выбрав **X** в центре верхней части страницы, где отображается IP-адрес. Появляется всплывающее окно с сообщением об отключении удаленного сеанса. Нажмите кнопку **ОК**.

1. Вернитесь на главную страницу портала Azure, выбрав **Microsoft Azure** на синей панели в верхней части страницы.

#### Удаление
**ВАЖНО!** В рамках этой задачи вы удалите группу ресурсов и все содержащиеся в ней ресурсы.   Это важно во избежание дополнительных затрат.

1. Откройте вкладку «SC900-WinVM – Microsoft Azure» в вашем браузере.

1. В левом верхнем углу страницы выберите **Все службы**.

1. В поле «Фильтровать службы» рядом с надписью «Все службы» введите **Группы ресурсов**, затем в результатах выберите **Группы ресурсов**.

1. Выберите **LabsSC900**.

1. Вверху по центру страницы LabsSC900 выберите **Удалить группу ресурсов**.

1. В открывшемся окне введите имя группы ресурсов **LabsSC900-RG** для подтверждения удаления группы ресурсов и содержащихся в ней ресурсов, затем выберите **Удалить** в нижней части страницы.

1. На удаление всех ресурсов и группы ресурсов может уйти несколько минут.

#### Обзор

В рамках этой демонстрации вы изучили сведения и настройки, связанные с NSG, включая процедуру привязки интерфейса к NSG, продемонстрировали правила входящего и исходящего трафика по умолчанию, а также действия по созданию нового правила.
